/*******************************************************************************
 * Copyright (c) 2018-2019 Aion foundation.
 *
 *     This file is part of the aion network project.
 *
 *     The aion network project is free software: you can redistribute it
 *     and/or modify it under the terms of the GNU General Public License
 *     as published by the Free Software Foundation, either version 3 of
 *     the License, or any later version.
 *
 *     The aion network project is distributed in the hope that it will
 *     be useful, but WITHOUT ANY WARRANTY; without even the implied
 *     warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
 *     See the GNU General Public License for more details.
 *
 *     You should have received a copy of the GNU General Public License
 *     along with the aion network project source files.
 *     If not, see <https://www.gnu.org/licenses/>.
 *
 ******************************************************************************/

use acore::client::{Client, ClientConfig, BlockChainClient};
use acore::client::header_chain::HeaderChain;
use aion_rpc::impls::EthClient;
use acore::spec::Spec;
use kvdb::{MockDbRepository, KeyValueDB};
use std::sync::Arc;
use std::path::Path;
use acore::db;
use acore::miner::Miner;
use acore::miner::external::ExternalMiner;
use acore::transaction::local_transactions::TxIoMessage;
use io::{IoChannel, IoService};
use sync::sync::{Sync, Params, SyncConfig, NetworkManager};
use sync::p2p::NetworkConfig;
use api_process::ApiProcess;

fn load<'a>(params: &'a String, b: &[u8]) -> Spec {
    match params.into() {
        Some(params) => Spec::load(params, b),
        None => Spec::load(&::std::env::temp_dir(), b),
    }
    .expect("chain spec is invalid")
}

fn new_spec() -> Spec {
    load(
        &"$HOME/.aion/cache_".into(),
        include_bytes!("../../../core/res/testnet.json"),
    )
}

fn new_db() -> Arc<KeyValueDB> {
    let mut db_configs = Vec::new();
    for db_name in db::DB_NAMES.to_vec() {
        db_configs.push(db_name.into());
    }
    Arc::new(MockDbRepository::init(db_configs))
}
fn new_miner(spec: &Spec, channel: IoChannel<TxIoMessage>) -> Arc<Miner> {
    let miner = Miner::with_spec(&spec);
    miner.set_tx_message_channel(channel);
    Arc::new(miner)
}

fn new_client(spec: &Spec, miner: Arc<Miner>) -> Arc<Client> {
    Client::new(
        ClientConfig::default(),
        spec,
        new_db(),
        miner,
        IoChannel::disconnected(),
    )
    .unwrap()
}

fn new_sync(client: Arc<Client>, header_chain: Arc<HeaderChain>) -> Arc<Sync> {
    Sync::get_instance(Params {
        config: SyncConfig::default(),
        client: client.clone(),
        network_config: NetworkConfig::default(),
        header_chain: header_chain,
    })
}

pub fn api_process_instance() -> ApiProcess {
    let spec = new_spec();
    let io_service = IoService::<TxIoMessage>::start().unwrap();
    let miner = new_miner(&spec, io_service.channel());
    let client = new_client(&spec, miner.clone());
    let header_chain = get_header_chain(&spec);
    // import a block
    let _ = client.import_block(ENCODEBLOCK.to_vec()).unwrap();
    // commit block
    ::std::thread::sleep(::std::time::Duration::from_millis(1000));
    client.import_verified_blocks();
    let sync = new_sync(client.clone(), header_chain);
    // start net work
    let net_manager: Arc<NetworkManager> = sync.clone();
    net_manager.start_network();
    let ethclient = Arc::new(EthClient::new(
        &client.clone(),
        &sync.clone(),
        &None,
        &miner.clone(),
        &Arc::new(ExternalMiner::default()),
        Default::default(),
    ));
    remove_test_db();
    ApiProcess::new(ethclient.clone(), io_service)
}

pub fn get_header_chain(spec: &Spec) -> Arc<HeaderChain> {
    let header_chain = HeaderChain::new(&Path::new("./test_db/"), spec).unwrap();
    return Arc::new(header_chain);
}

pub fn remove_test_db() {
    let path = Path::new("./test_db/");
    let _ = ::std::fs::remove_dir_all(path);
}

static ENCODEBLOCK: &[u8] = &[
    249, 8, 55, 249, 7, 140, 1, 1, 160, 9, 137, 235, 131, 120, 36, 50, 113, 250, 93, 215, 140, 120,
    190, 191, 132, 162, 166, 100, 201, 148, 226, 183, 161, 114, 70, 202, 246, 240, 150, 169, 79,
    160, 160, 7, 118, 119, 232, 0, 117, 178, 252, 123, 220, 233, 148, 3, 45, 160, 149, 208, 66, 49,
    67, 13, 203, 26, 158, 104, 123, 143, 44, 67, 34, 76, 160, 54, 236, 100, 85, 130, 238, 208, 120,
    93, 145, 138, 188, 248, 50, 127, 159, 150, 36, 87, 76, 162, 97, 106, 220, 107, 188, 144, 150,
    91, 110, 224, 150, 160, 28, 157, 181, 36, 228, 97, 53, 203, 63, 73, 95, 147, 55, 238, 200, 105,
    202, 115, 233, 8, 16, 73, 225, 196, 8, 73, 74, 211, 111, 3, 102, 158, 160, 249, 141, 202, 163,
    17, 255, 218, 93, 69, 79, 2, 205, 193, 169, 152, 160, 119, 245, 73, 52, 132, 23, 252, 109, 47,
    135, 135, 84, 228, 5, 163, 60, 185, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 144, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
    160, 65, 73, 79, 78, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 130, 82, 12, 131, 228, 168, 136, 132, 91, 238, 38, 233, 160, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 185, 5, 128, 0, 20,
    158, 36, 51, 0, 37, 184, 108, 24, 198, 11, 70, 58, 210, 69, 121, 201, 28, 255, 253, 160, 13,
    212, 220, 79, 59, 76, 204, 244, 187, 82, 159, 71, 157, 91, 54, 147, 106, 34, 199, 237, 60, 250,
    22, 84, 158, 139, 92, 171, 28, 32, 114, 194, 0, 121, 202, 99, 73, 117, 156, 92, 71, 186, 20,
    92, 66, 93, 19, 159, 138, 204, 228, 165, 255, 6, 201, 78, 252, 102, 117, 115, 236, 37, 164, 58,
    249, 38, 7, 86, 44, 237, 151, 167, 112, 197, 241, 78, 218, 22, 123, 234, 30, 159, 22, 113, 8,
    48, 138, 219, 12, 178, 247, 6, 12, 115, 124, 144, 98, 216, 101, 24, 145, 19, 66, 181, 187, 35,
    95, 240, 176, 155, 17, 156, 45, 177, 169, 104, 241, 182, 237, 190, 121, 18, 146, 238, 188, 244,
    28, 217, 179, 60, 159, 160, 54, 222, 90, 198, 180, 182, 147, 238, 229, 52, 69, 144, 214, 55,
    160, 31, 9, 115, 210, 251, 142, 207, 0, 229, 112, 255, 159, 176, 65, 56, 196, 213, 229, 111,
    101, 3, 232, 59, 86, 250, 107, 237, 117, 123, 8, 197, 98, 96, 155, 23, 150, 20, 239, 235, 105,
    31, 181, 174, 150, 152, 20, 103, 96, 219, 78, 237, 12, 86, 223, 122, 44, 113, 103, 134, 191, 4,
    29, 65, 161, 213, 192, 213, 166, 99, 80, 55, 131, 77, 19, 101, 7, 189, 64, 214, 221, 66, 53,
    252, 249, 51, 255, 218, 111, 40, 4, 147, 217, 184, 191, 7, 10, 63, 42, 43, 24, 97, 89, 57, 255,
    95, 20, 38, 235, 65, 193, 83, 12, 162, 169, 187, 180, 51, 40, 53, 185, 140, 47, 217, 20, 88,
    245, 40, 169, 53, 213, 80, 218, 12, 69, 168, 74, 177, 180, 164, 14, 152, 29, 79, 81, 50, 152,
    84, 205, 158, 88, 135, 93, 86, 152, 207, 159, 86, 13, 63, 25, 13, 26, 168, 185, 47, 217, 216,
    21, 92, 111, 176, 151, 84, 49, 73, 223, 138, 205, 42, 7, 181, 52, 4, 1, 23, 96, 246, 185, 82,
    85, 232, 117, 248, 104, 25, 30, 133, 237, 232, 233, 34, 86, 166, 135, 80, 10, 16, 207, 248,
    126, 99, 120, 113, 22, 163, 58, 75, 28, 166, 107, 164, 110, 197, 131, 254, 80, 164, 30, 32, 33,
    81, 215, 3, 94, 195, 41, 205, 22, 65, 158, 7, 112, 120, 164, 155, 228, 152, 240, 9, 47, 34,
    153, 203, 220, 199, 51, 132, 241, 127, 165, 87, 115, 222, 51, 166, 215, 66, 61, 36, 3, 197, 2,
    21, 194, 230, 121, 96, 206, 70, 208, 168, 153, 74, 90, 14, 116, 86, 88, 90, 123, 38, 163, 105,
    37, 227, 35, 220, 1, 194, 249, 12, 244, 49, 87, 75, 83, 151, 231, 185, 70, 98, 24, 40, 35, 199,
    25, 197, 111, 49, 25, 118, 68, 165, 160, 57, 228, 50, 38, 215, 87, 113, 174, 1, 134, 60, 3,
    129, 33, 129, 178, 193, 236, 134, 243, 135, 179, 137, 166, 102, 56, 145, 238, 140, 73, 230, 72,
    118, 50, 138, 1, 255, 51, 229, 7, 10, 54, 162, 173, 191, 184, 17, 119, 195, 64, 206, 75, 124,
    172, 124, 162, 13, 9, 209, 251, 129, 145, 225, 17, 104, 254, 122, 233, 74, 31, 205, 211, 5,
    149, 5, 46, 55, 232, 2, 16, 129, 193, 101, 245, 168, 10, 124, 241, 70, 229, 23, 53, 85, 9, 171,
    115, 107, 107, 218, 96, 48, 34, 145, 174, 5, 201, 199, 24, 227, 170, 12, 168, 84, 229, 103,
    157, 248, 165, 174, 95, 97, 64, 21, 5, 202, 87, 14, 76, 100, 157, 173, 154, 164, 212, 23, 133,
    74, 5, 191, 105, 70, 160, 125, 145, 2, 15, 71, 213, 85, 156, 49, 37, 240, 170, 95, 252, 160,
    24, 239, 50, 47, 61, 46, 36, 117, 30, 236, 11, 71, 252, 61, 25, 58, 128, 245, 172, 224, 52, 38,
    189, 97, 48, 31, 147, 85, 182, 85, 188, 184, 40, 103, 247, 156, 144, 134, 76, 127, 55, 63, 94,
    44, 63, 130, 228, 235, 38, 116, 99, 36, 244, 62, 0, 239, 170, 51, 135, 117, 40, 114, 175, 151,
    90, 39, 9, 159, 105, 220, 22, 184, 103, 226, 36, 235, 28, 155, 210, 9, 192, 110, 223, 252, 125,
    191, 202, 54, 242, 201, 62, 119, 36, 229, 65, 26, 189, 149, 7, 219, 84, 138, 120, 210, 85, 235,
    240, 13, 146, 22, 178, 143, 78, 81, 133, 200, 23, 47, 3, 176, 10, 253, 108, 253, 254, 97, 181,
    228, 226, 249, 225, 17, 180, 252, 95, 154, 133, 46, 27, 171, 43, 184, 12, 132, 247, 236, 72,
    247, 99, 251, 61, 207, 162, 40, 7, 31, 41, 58, 218, 94, 238, 61, 161, 209, 55, 230, 96, 244,
    240, 68, 39, 134, 162, 110, 223, 206, 181, 75, 153, 163, 126, 89, 179, 191, 63, 227, 42, 141,
    102, 106, 227, 73, 34, 163, 181, 43, 4, 46, 227, 237, 210, 207, 131, 71, 15, 106, 47, 44, 47,
    125, 163, 134, 226, 52, 35, 211, 26, 5, 164, 64, 217, 193, 34, 129, 197, 229, 6, 50, 176, 17,
    12, 144, 170, 250, 194, 87, 67, 13, 45, 240, 112, 34, 214, 217, 136, 105, 232, 6, 221, 41, 113,
    28, 62, 118, 151, 156, 1, 181, 249, 56, 155, 166, 200, 94, 7, 7, 37, 227, 202, 119, 12, 252,
    180, 19, 26, 67, 147, 0, 195, 194, 28, 82, 101, 10, 7, 42, 160, 248, 177, 233, 234, 27, 194,
    122, 165, 194, 77, 242, 251, 252, 183, 141, 233, 219, 126, 171, 129, 83, 1, 149, 200, 131, 198,
    55, 254, 236, 12, 1, 16, 116, 184, 108, 203, 166, 240, 164, 100, 117, 90, 110, 59, 102, 186,
    44, 124, 86, 143, 191, 152, 235, 24, 143, 228, 228, 48, 98, 229, 0, 32, 168, 39, 24, 145, 46,
    153, 45, 130, 175, 194, 97, 70, 230, 19, 212, 25, 3, 75, 35, 88, 28, 108, 13, 146, 42, 51, 246,
    197, 235, 230, 44, 176, 178, 185, 22, 27, 185, 155, 198, 102, 19, 2, 96, 207, 14, 237, 45, 208,
    179, 149, 186, 214, 156, 63, 185, 86, 213, 5, 45, 198, 169, 155, 193, 215, 137, 177, 4, 199,
    19, 74, 145, 210, 220, 136, 69, 38, 112, 7, 54, 7, 240, 236, 136, 181, 49, 17, 186, 59, 74,
    161, 40, 62, 159, 186, 220, 84, 87, 3, 151, 204, 156, 25, 16, 119, 160, 43, 153, 15, 13, 164,
    134, 151, 45, 209, 14, 109, 158, 212, 253, 138, 39, 235, 183, 37, 217, 142, 112, 193, 213, 30,
    207, 242, 42, 135, 53, 63, 182, 63, 30, 228, 32, 178, 24, 209, 235, 16, 134, 110, 168, 109, 51,
    168, 73, 28, 31, 137, 71, 136, 87, 29, 223, 182, 169, 177, 244, 175, 155, 18, 242, 186, 120, 9,
    86, 214, 193, 231, 49, 225, 65, 100, 65, 49, 100, 8, 171, 149, 181, 92, 112, 34, 169, 216, 236,
    165, 167, 173, 82, 249, 101, 167, 45, 203, 109, 24, 99, 71, 9, 135, 165, 243, 177, 67, 125,
    170, 55, 217, 7, 203, 91, 168, 248, 184, 80, 79, 215, 44, 129, 78, 11, 237, 187, 68, 24, 8,
    130, 51, 110, 119, 247, 229, 115, 179, 168, 184, 33, 215, 174, 242, 188, 215, 167, 131, 173,
    111, 231, 14, 129, 187, 79, 50, 195, 195, 102, 244, 54, 239, 60, 118, 15, 189, 210, 121, 86,
    58, 57, 222, 4, 42, 69, 115, 123, 120, 115, 32, 162, 104, 174, 1, 64, 111, 146, 10, 3, 230,
    169, 161, 52, 188, 74, 48, 65, 39, 54, 239, 148, 72, 138, 127, 72, 235, 74, 5, 245, 103, 24,
    248, 121, 253, 240, 179, 94, 12, 131, 15, 227, 138, 209, 147, 34, 198, 97, 250, 26, 138, 243,
    123, 231, 163, 250, 131, 185, 53, 150, 31, 46, 94, 133, 137, 212, 213, 90, 252, 170, 22, 39,
    14, 19, 205, 173, 251, 5, 146, 63, 184, 77, 19, 147, 188, 141, 26, 24, 1, 71, 117, 106, 133,
    30, 227, 2, 49, 156, 100, 109, 119, 31, 170, 18, 24, 233, 221, 201, 213, 252, 73, 126, 57, 252,
    185, 151, 105, 254, 99, 198, 218, 247, 136, 253, 149, 235, 248, 166, 248, 164, 0, 160, 160, 78,
    178, 238, 189, 76, 42, 26, 207, 140, 55, 73, 38, 191, 217, 197, 77, 2, 220, 228, 71, 199, 141,
    176, 151, 133, 47, 163, 130, 4, 32, 179, 136, 13, 224, 182, 179, 167, 100, 0, 0, 0, 136, 0, 5,
    122, 190, 169, 68, 185, 126, 130, 85, 240, 136, 0, 0, 0, 2, 84, 11, 228, 0, 1, 184, 96, 3, 234,
    88, 194, 67, 246, 221, 233, 118, 254, 208, 252, 227, 107, 252, 198, 30, 66, 140, 225, 199, 105,
    126, 85, 96, 171, 81, 34, 182, 222, 93, 109, 180, 193, 117, 64, 0, 95, 110, 56, 184, 23, 117,
    134, 129, 89, 163, 123, 184, 247, 177, 201, 69, 61, 231, 154, 136, 212, 231, 41, 65, 235, 77,
    119, 145, 226, 208, 199, 211, 50, 136, 78, 94, 129, 130, 117, 140, 37, 220, 224, 154, 249, 39,
    178, 159, 202, 108, 44, 173, 101, 49, 183, 87, 206, 30, 1,
];
